<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot VDM</title>

    <style>
        /* ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Chat Container */
        .chat-container {
            width: 100%;
            max-width: 600px;
            height: 90vh;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            overflow: hidden;
        }

        /* Header */
        .chat-header {
            background: linear-gradient(90deg, #4c8bf5, #2b65d9);
            color: #ffffff;
            text-align: center;
            padding: 20px;
            font-size: 1.8rem;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Chat Log */
        .chat-log {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f9f9f9;
        }

        .chat-message {
            margin: 10px 0;
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 15px;
            line-height: 1.5;
            word-wrap: break-word;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .user-message {
            background: #4c8bf5;
            color: #ffffff;
            margin-left: auto;
        }

        .bot-message {
            background: #e4e6eb;
            color: #333333;
        }

        /* Typing Indicator */
        .typing-indicator {
            font-size: 1.1rem;
            color: #999;
            animation: typingDots 1s infinite steps(3);
        }

        @keyframes typingDots {

            0%,
            33% {
                content: ".";
            }

            66% {
                content: "..";
            }

            100% {
                content: "...";
            }
        }

        /* Chat Input Bar */
        .chat-input {
            display: flex;
            align-items: center;
            padding: 15px;
            border-top: 1px solid #ddd;
            background: #ffffff;
            box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.1);
        }

        .chat-input input {
            flex: 1;
            padding: 15px;
            border: 2px solid #4c8bf5;
            border-radius: 30px;
            font-size: 1rem;
            outline: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chat-input button {
            margin-left: 10px;
            background: linear-gradient(90deg, #4c8bf5, #2b65d9);
            color: #ffffff;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .chat-input button:hover {
            background: #2b65d9;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-header {
                font-size: 1.5rem;
                padding: 15px;
            }

            .chat-input input {
                font-size: 1rem;
                padding: 12px;
            }

            .chat-input button {
                font-size: 1rem;
                padding: 12px 18px;
            }
        }

        .chat-header {
            display: flex;
            flex-direction: row;
            /* ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
            align-items: center;
            /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
            justify-content: center;
            /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
            background: linear-gradient(90deg, #4c8bf5, #2b65d9);
            color: #ffffff;
            padding: 15px 10;
            font-size: 1.5rem;
            font-weight: bold;
            position: relative;

        }

        .center-logo {
            width: 100px;
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ */
            height: auto;
            margin-right: 20px;
            /* ‡∏Ç‡∏¢‡∏±‡∏ö‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ */
            margin-bottom: 5px;
            /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .header-text {
            text-align: center;
            font-size: 1.7rem;
        }
    </style>
</head>

<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <!-- <img src="image/feed.jpg" alt="Logo" class="center-logo">-->
            <div class="header-text">VDM Genie Pro3</div>

        </div>

        <!-- Chat Log -->
        <div class="chat-log" id="chat-log"></div>

        <!-- Chat Input -->
        <div class="chat-input">
            <input type="text" id="user-input" placeholder="Type your message...">
            <button onclick="sendMessage()">Send</button>
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û -->
            <button onclick="triggerImageUpload()">Upload Image</button>
            <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="previewImage(event)">
        </div>
    </div>

    <script>
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        function readAloud(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; // ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
            speechSynthesis.speak(utterance);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥
        function createEmojiPopup(targetElement, text) {
            // ‡∏•‡∏ö‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            const existingPopup = document.getElementById('emoji-popup');
            if (existingPopup) existingPopup.remove();

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡πÉ‡∏´‡∏°‡πà
            const popup = document.createElement('div');
            popup.id = 'emoji-popup';
            popup.style.position = 'absolute';
            popup.style.background = '#fff';
            popup.style.border = '1px solid #ccc';
            popup.style.borderRadius = '10px';
            popup.style.padding = '5px 10px';
            popup.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            popup.style.cursor = 'pointer';
            popup.style.fontSize = '1.5rem';

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            const rect = targetElement.getBoundingClientRect();
            popup.style.left = `${rect.left + window.pageXOffset}px`;
            popup.style.top = `${rect.top - 40 + window.pageYOffset}px`;

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡∏£‡∏π‡∏õ‡∏•‡∏≥‡πÇ‡∏û‡∏á
            popup.textContent = 'üîä';
            popup.addEventListener('click', () => {
                readAloud(text);
                popup.remove(); // ‡∏•‡∏ö‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
            });

            document.body.appendChild(popup);

            // ‡∏•‡∏ö‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
            document.addEventListener('click', (e) => {
                if (!popup.contains(e.target) && e.target !== targetElement) {
                    popup.remove();
                }
            }, { once: true });
        }



        const apiUrl = "https://script.google.com/macros/s/AKfycbw8NmBDeYgjcH7R8j_WRkH-b7Y5z3w-T2OxZ85Y9uWj5fWg3ftsocUJx55053Q5k_tc/exec";




        let conversationContext = ""; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö Context ‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
        function addMessage(sender, message, className) {
            const chatLog = document.getElementById("chat-log");
            const messageElement = document.createElement("div");
            messageElement.classList.add("chat-message", className);
            messageElement.textContent = message;
            chatLog.appendChild(messageElement);

            let pressTimer; // ‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Event ‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á
            messageElement.addEventListener('mousedown', () => {
                pressTimer = setTimeout(() => {
                    createEmojiPopup(messageElement, message); // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ
                }, 1000); // ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            });
            messageElement.addEventListener('mouseup', () => clearTimeout(pressTimer));
            messageElement.addEventListener('mouseleave', () => clearTimeout(pressTimer));
            messageElement.addEventListener('touchstart', () => {
                pressTimer = setTimeout(() => {
                    createEmojiPopup(messageElement, message); // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ
                }, 1000); // ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            });
            messageElement.addEventListener('touchend', () => clearTimeout(pressTimer));
        }


        async function logUserQuestion(message) {
            try {
                // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà API (POST)
                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `userInput=${encodeURIComponent(message)}`
                });
                const result = await response.json();

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á Context ‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                return `I don't quite understand the question you're asking. Can you please provide more specific words or details? üòä`;
            } catch (error) {
                console.error("There was an error saving the question:", error);
                return "An error occurred connecting to the database. ‚ùå";
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Bot ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
        function showTypingIndicator() {
            const chatLog = document.getElementById("chat-log");
            const typingIndicator = document.createElement("div");
            typingIndicator.classList.add("chat-message", "bot-message", "typing-indicator");
            typingIndicator.textContent = "..."; // ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏Ç‡πà‡∏õ‡∏•‡∏≤
            typingIndicator.id = "typing-indicator"; // ‡∏ï‡∏±‡πâ‡∏á ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏á‡πà‡∏≤‡∏¢
            chatLog.appendChild(typingIndicator);
            chatLog.scrollTop = chatLog.scrollHeight; // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ä‡∏ó‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Bot ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById("typing-indicator");
            if (typingIndicator) {
                typingIndicator.remove(); // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DOM
            }
        }

        // Synonym Mapping (‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á)
        const synonyms = {
            "hi": ["hello", "hey", "hiya"],
            "thanks": ["thank you", "thx", "appreciate"],
            "error": ["problem", "issue", "bug"],
            "stuck": ["freeze", "hang", "stop"]
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà Synonym
        function matchSynonyms(userInput, data) {
            const words = tokenize(userInput); // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            for (let word of words) {
                for (let key in synonyms) {
                    if (synonyms[key].includes(word)) {
                        userInput = userInput.replace(word, key); // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
                    }
                }
            }
            return userInput;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥
        function cleanText(text) {
            return text.toLowerCase().replace(/[^\w\s]/gi, '').trim();
        }

        function tokenize(text) {
            return cleanText(text).split(" "); // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô Array
        }

        async function loadDictionary() {
            const response = await fetch("https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt");
            const text = await response.text();
            return text.split("\n"); // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏õ‡πá‡∏ô array
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏∞‡∏Å‡∏î
        async function correctSpelling(input) {
            const dictionary = await loadDictionary(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Levenshtein Distance
            function levenshteinDistance(a, b) {
                const matrix = [];
                for (let i = 0; i <= b.length; i++) {
                    matrix[i] = [i];
                }
                for (let j = 0; j <= a.length; j++) {
                    matrix[0][j] = j;
                }
                for (let i = 1; i <= b.length; i++) {
                    for (let j = 1; j <= a.length; j++) {
                        if (b.charAt(i - 1) === a.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1, // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
                                Math.min(
                                    matrix[i][j - 1] + 1, // ‡∏•‡∏ö
                                    matrix[i - 1][j] + 1 // ‡πÄ‡∏û‡∏¥‡πà‡∏°
                                )
                            );
                        }
                    }
                }
                return matrix[b.length][a.length];
            }

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤ closest match
            function findClosestWord(word, dictionary) {
                let closestWord = word;
                let lowestDistance = Infinity;

                for (const dictWord of dictionary) {
                    const distance = levenshteinDistance(word.toLowerCase(), dictWord.toLowerCase());
                    if (distance < lowestDistance) {
                        lowestDistance = distance;
                        closestWord = dictWord;
                    }
                }
                return closestWord;
            }

            // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡πÉ‡∏ô input ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏≥
            const words = input.split(" ");
            const correctedWords = words.map(word => findClosestWord(word, dictionary));
            return correctedWords.join(" ");
        }

        // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
        (async () => {
            const userInput = "helo we have probem";
            const correctedInput = await correctSpelling(userInput);
            console.log(correctedInput); // Output: "hello we have problem"
        })();

        function findClosestMatch(userInput, data) {
            let closestMatch = null;
            let highestSimilarity = 0;

            for (let item of data) {
                const similarity = calculateSimilarity(userInput, item.user);
                if (similarity > highestSimilarity) {
                    highestSimilarity = similarity;
                    closestMatch = item.answer;
                }
            }

            return highestSimilarity >= 0.5 ? closestMatch : null; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î threshold
        }

        function calculateSimilarity(str1, str2) {
            const words1 = str1.toLowerCase().split(" ");
            const words2 = str2.toLowerCase().split(" ");
            const matches = words1.filter(word => words2.includes(word));
            return matches.length / Math.max(words1.length, words2.length);
        }


        let conversationHistory = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

        let unknownResponseCount = 0; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà Bot ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à

        async function sendMessage() {
            const userInput = document.getElementById("user-input");
            let message = userInput.value.trim();

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const englishRegex = /^[a-zA-Z0-9\s.,?!'‚Äô‚Äò"‚Äú‚Äù\u2018\u2019\u201C\u201D\u00A0:;(){}[\]<>+*=/@#&%$^_|~-\u1F600-\u1F64F\u1F300-\u1F5FF\u1F680-\u1F6FF\u2600-\u26FF\u2700-\u27BF]+$/;

            if (message !== "") {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
                addMessage("You", message, "user-message");

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏©‡∏≤
                if (!englishRegex.test(message)) {
                    addMessage("Bot", "Sorry, I only support English. üòä", "bot-message");
                    userInput.value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                    return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
                }

                userInput.value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡πà‡∏≠‡∏á‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°

                try {
                    showTypingIndicator(); // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Bot ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå

                    const response = await fetch(apiUrl);
                    const data = await response.json();

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
                    message = processContext(conversationHistory, message, data);
                    let answer = findClosestMatch(message, data);

                    if (!answer) {
                        answer = await logUserQuestion(message);
                    }

                    hideTypingIndicator(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Bot ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å Bot
                    addMessage("Bot", answer, "bot-message");

                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
                    conversationHistory.push({ user: message, bot: answer });
                } catch (error) {
                    hideTypingIndicator();
                    addMessage("Bot", "An error occurred connecting to the API. ‚ùå", "bot-message");
                }
            }
        }
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å input file
        function triggerImageUpload() {
            const fileInput = document.getElementById('image-upload');
            fileInput.click(); // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û
        function previewImage(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏†‡∏≤‡∏û‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
        const reader = new FileReader();
        reader.onload = function (e) {
            const chatLog = document.getElementById('chat-log');

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            const userMessage = document.createElement('div');
            userMessage.classList.add("chat-message", "user-message"); // ‡πÉ‡∏ä‡πâ "user-message" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡∏≠‡∏¢‡∏π‡πà‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            const imgPreview = document.createElement('img');
            imgPreview.src = e.target.result;
            imgPreview.style.maxWidth = "100%";
            imgPreview.style.borderRadius = "10px";
            imgPreview.style.margin = "10px 0";

            userMessage.appendChild(imgPreview);
            chatLog.appendChild(userMessage);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á popup ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            const popupContainer = document.createElement('div');
            popupContainer.style.position = 'fixed';
            popupContainer.style.bottom = '15%';
            popupContainer.style.left = '50%';
            popupContainer.style.transform = 'translateX(-50%)';
            popupContainer.style.background = 'rgba(0, 0, 0, 0.8)';
            popupContainer.style.padding = '20px';
            popupContainer.style.borderRadius = '10px';
            popupContainer.style.boxShadow = '0 4px 10px rgba(0, 0, 0, 0.3)';
            popupContainer.style.zIndex = '1000';
            popupContainer.style.textAlign = 'center';

            const confirmButton = document.createElement('button');
            confirmButton.textContent = "Confirm Image";
            confirmButton.style.margin = "10px";
            confirmButton.style.padding = "10px 20px";
            confirmButton.style.border = 'none';
            confirmButton.style.borderRadius = '5px';
            confirmButton.style.background = '#4caf50';
            confirmButton.style.color = '#fff';
            confirmButton.style.cursor = 'pointer';
            confirmButton.style.fontSize = '1rem';
            confirmButton.onclick = function () {
                sendImage(file);
                popupContainer.remove(); // ‡∏•‡∏ö popup
            };

            const cancelButton = document.createElement('button');
            cancelButton.textContent = "Cancel";
            cancelButton.style.margin = "10px";
            cancelButton.style.padding = "10px 20px";
            cancelButton.style.border = 'none';
            cancelButton.style.borderRadius = '5px';
            cancelButton.style.background = '#f44336';
            cancelButton.style.color = '#fff';
            cancelButton.style.cursor = 'pointer';
            cancelButton.style.fontSize = '1rem';
            cancelButton.onclick = function () {
                userMessage.remove(); // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏†‡∏≤‡∏û
                popupContainer.remove(); // ‡∏•‡∏ö popup
            };

            popupContainer.appendChild(confirmButton);
            popupContainer.appendChild(cancelButton);
            document.body.appendChild(popupContainer);
        };

        reader.readAsDataURL(file);
    }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
        async function sendImage(file) {
            const formData = new FormData();
            formData.append('image', file);

            try {
                showTypingIndicator();

                const response = await fetch('https://apivdm-1.onrender.com/upload_image', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`Server responded with status ${response.status}`);
                }

                const data = await response.json();
                hideTypingIndicator();

                if (data.response) {
                    addMessage("Bot", data.response, "bot-message");  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ö‡∏≠‡∏ó
                } else {
                    addMessage("Bot", "Sorry, no relevant information found.", "bot-message");
                }
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                addMessage("Bot", `Failed to analyze the image. ‚ùå\nError: ${error.message}`, "bot-message");
            }
        }

        function showTypingIndicator() {
            const chatLog = document.getElementById("chat-log");
            const typingIndicator = document.createElement("div");
            typingIndicator.classList.add("chat-message", "bot-message", "typing-indicator");
            typingIndicator.textContent = "Analyzing image..."; // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
            typingIndicator.id = "typing-indicator"; // ‡∏ï‡∏±‡πâ‡∏á ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏á‡πà‡∏≤‡∏¢
            chatLog.appendChild(typingIndicator);
            chatLog.scrollTop = chatLog.scrollHeight; // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ä‡∏ó‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
        }
        function processContext(history, message, data) {
            const userMessage = message.toLowerCase();

            // ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ Context ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå
            const resetKeywords = ["thank you", "thanks", "hi", "hello", "ok", "done", "finish", "I'm fine"];

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏à‡∏ö‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
            if (resetKeywords.some(keyword => userMessage.includes(keyword))) {
                history.length = 0; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Context
                return message; // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÉ‡∏´‡∏°‡πà
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            for (let item of data) {
                if (userMessage.includes(item.user.toLowerCase())) {
                    history.length = 0; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Context ‡πÄ‡∏î‡∏¥‡∏°
                    return message; // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÉ‡∏´‡∏°‡πà
                }
            }

            // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö Context ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡∏à‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (history.length > 0) {
                const lastContext = history[history.length - 1].user; // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                return `${lastContext} ${message}`.trim(); // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            }

            return message; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Context ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        document.getElementById("user-input").addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
                sendMessage();
            }
        });
    </script>
</body>

</html>
